{% extends "base.html" %} {% block title %}Trang Cá Nhân{% endblock %} {% block
content %}
<h1 class="text-center">Thông tin cá nhân</h1>

<div class="card">
  <div class="card-body">
    <h5 class="card-title">Xin chào, <span id="userFullName">...</span>!</h5>
    <p class="card-text">
      <strong>Email:</strong> <span id="userEmail">...</span>
    </p>
    <p class="card-text">
      <strong>Loại tài khoản:</strong> <span id="userType">...</span>
    </p>
    <p class="card-text">
      <strong>Số lượt sử dụng còn lại:</strong> <span id="userCount">...</span>
    </p>
    <p class="card-text">
      <strong>Token Hiện Tại:</strong> <span id="userToken">...</span>
    </p>
    <p class="card-text">
      <strong>Token Hết Hạn Vào:</strong> <span id="tokenExpiry">...</span>
    </p>

    <button onclick="updateProfile()" class="btn btn-primary">
      Cập Nhật Hồ Sơ
    </button>
    <button onclick="logout()" class="btn btn-danger">Đăng xuất</button>
  </div>
</div>

<script>
  async function fetchProfile() {
    const token = localStorage.getItem("token");
    if (!token) {
      alert("Bạn chưa đăng nhập!");
      window.location.href = "/login";
      return;
    }

    try {
      const response = await fetch(
        `https://api.pplt-dev.vitlab.site/api/users/profile`,
        {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            //"Authorization": `Bearer ${token}` // Cần có "Bearer "
            Authorization: token,
          },
        }
      );

      const user = await response.json();
      if (response.ok) {
        document.getElementById("userFullName").innerText =
          user.full_name || "N/A";
        document.getElementById("userEmail").innerText = user.email || "N/A";
        document.getElementById("userType").innerText = user.type || "N/A";
        document.getElementById("userCount").innerText =
          user.count !== undefined ? user.count : "N/A";
        document.getElementById("userToken").innerText = token;
        document.getElementById("tokenExpiry").innerText = user.expiresAt
          ? new Date(user.expiresAt).toLocaleString("vi-VN")
          : "N/A";

        // ✅ Kiểm tra token hết hạn → Nếu hết hạn, yêu cầu đăng nhập lại
        if (new Date(user.expiresAt) < new Date()) {
          alert("Phiên đăng nhập đã hết hạn! Vui lòng đăng nhập lại.");
          logout();
        }
      } else {
        alert("Lỗi: " + user.message);
        logout();
      }
    } catch (error) {
      alert("Lỗi kết nối đến server!");
      console.error(error);
    }
  }

  function updateProfile() {
    window.location.href = "/updateprofile";
  }

  function logout() {
    localStorage.removeItem("token");
    window.location.href = "/login";
  }

  fetchProfile();
</script>
{% endblock %}
