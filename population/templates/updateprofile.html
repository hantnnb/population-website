{% extends "base.html" %} {% block title %}Cập Nhật Hồ Sơ{% endblock %} {% block
content %}
<h1 class="text-center">Cập Nhật Hồ Sơ</h1>

<div class="card">
  <div class="card-body">
    <form id="updateForm">
      <div class="mb-3">
        <label class="form-label">Họ Tên</label>
        <input type="text" id="fullName" class="form-control" />
      </div>
      <div class="mb-3">
        <label class="form-label">Email</label>
        <input type="email" id="email" class="form-control" readonly />
      </div>
      <div class="mb-3">
        <label class="form-label">Mật Khẩu Mới</label>
        <input type="password" id="newPassword" class="form-control" />
      </div>
      <button type="submit" class="btn btn-success">Lưu Thay Đổi</button>
    </form>
  </div>
</div>

<script>
  async function fetchUserProfile() {
    const token = localStorage.getItem("token");
    if (!token) {
      alert("Bạn chưa đăng nhập!");
      window.location.href = "/login";
      return;
    }

    try {
      const response = await fetch(
        `https://api.pplt-prod.vitlab.site/api/users/profile`,
        {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: token,
          },
        }
      );

      const user = await response.json();
      if (response.ok) {
        document.getElementById("fullName").value = user.full_name;
        document.getElementById("email").value = user.email;
      } else {
        alert("Lỗi: " + user.message);
        localStorage.removeItem("token");
        window.location.href = "/login";
      }
    } catch (error) {
      alert("Lỗi kết nối đến server!");
      console.error(error);
    }
  }

  document
    .getElementById("updateForm")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      const token = localStorage.getItem("token");

      const updateData = {
        full_name: document.getElementById("fullName").value,
        new_password: document.getElementById("newPassword").value,
      };

      try {
        const response = await fetch(
          `https://api.pplt-prod.vitlab.site/api/users/update`,
          {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: token,
            },
            body: JSON.stringify(updateData),
          }
        );

        const result = await response.json();
        if (response.ok) {
          alert("Cập nhật thành công!");
          window.location.href = "/profile";
        } else {
          alert("Lỗi: " + result.message);
        }
      } catch (error) {
        alert("Lỗi kết nối đến server!");
        console.error(error);
      }
    });

  fetchUserProfile();
</script>
{% endblock %}
