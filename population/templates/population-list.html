{% extends "base.html" %} {% block title %}Admin{% endblock %} {% block content
%}

<h1 class="text-center">Danh sách các tỉnh thành</h1>

<!-- Ô tìm kiếm -->
<div class="input-group mb-1">
  <input
    type="text"
    id="searchInput"
    class="form-control"
    placeholder="Tìm kiếm tỉnh thành..."
  />
  <button class="btn btn-primary" onclick="handleSearch()">Tìm kiếm</button>
</div>
<button class="btn btn-success mb-1" onclick="openModal()">Thêm Mới</button>

<!-- Danh sách tỉnh thành -->
<div
  id="population-container"
  style="max-height: 650px; overflow-y: scroll"
></div>

<!-- Phân trang với dropdown -->
<div class="d-flex justify-content-center align-items-center mt-1">
  <button class="btn btn-primary me-2" onclick="prevPage()" id="prevBtn">
    Trước
  </button>
  <select
    class="form-select w-auto"
    id="pageSelect"
    onchange="changePage()"
  ></select>
  <button class="btn btn-primary ms-2" onclick="nextPage()" id="nextBtn">
    Tiếp
  </button>
</div>

<script>
  let currentPage = 1;
  let totalPages = 1;
  let searchQuery = "";

  async function fetchPopulation(page = 1, search = "") {
    const response = await fetch(
      `https://api.vnpop.thonh.site/api/populations?page=${page}&limit=5&search=${search}`
    );
    const data = await response.json();

    totalPages = data.totalPages;
    currentPage = page;

    let htmlContent = "";
    data["data"].forEach((article) => {
      htmlContent += `
        <div class="card mt-4">
          <div class="card-body">
            <h5 class="card-title">${article.province}</h5>
            <p class="card-text">Mật độ dân số (người/km²): ${article.populationDensity}</p>
            <p class="card-text">Dân số trung bình (nghìn người): ${article.averagePopulation}</p>
            <p class="card-text">Tỷ lệ giới tính (nam/nữ): ${article.genderRatio}</p>
            <p class="card-text">Lực lượng lao động (nghìn người): ${article.laborForce}</p>
            <p class="card-text">Tỷ lệ gia tăng dân số (%): ${article.populationGrowthRate}</p>
           <a href="#" class="btn btn-primary" onclick="openModal('${article._id}')">Chỉnh sửa</a>
<a href="#" class="btn btn-danger" onclick="deletePopulation('${article._id}')">Xoá</a>
          </div>
        </div>
<!-- Bootstrap Modal -->
<div class="modal fade" id="populationModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalLabel">Thêm / Chỉnh Sửa Dữ Liệu</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="populationForm">
          <input type="hidden" id="recordId" />
          <div class="mb-3">
            <label for="province" class="form-label">Tỉnh thành</label>
            <input type="text" id="province" class="form-control" required />
          </div>
          <div class="mb-3">
            <label for="populationDensity" class="form-label">Mật độ dân số</label>
            <input type="number" id="populationDensity" class="form-control" required />
          </div>
          <div class="mb-3">
            <label for="averagePopulation" class="form-label">Dân số trung bình</label>
            <input type="number" id="averagePopulation" class="form-control" required />
          </div>
          <div class="mb-3">
            <label for="genderRatio" class="form-label">Tỷ lệ giới tính</label>
            <input type="number" step="0.1" id="genderRatio" class="form-control" required />
          </div>
          <div class="mb-3">
            <label for="laborForce" class="form-label">Lực lượng lao động</label>
            <input type="number" id="laborForce" class="form-control" required />
          </div>
          <div class="mb-3">
            <label for="populationGrowthRate" class="form-label">Tỷ lệ gia tăng dân số</label>
            <input type="number" step="0.1" id="populationGrowthRate" class="form-control" required />
          </div>
                    <div class="mb-3">
            <label for="region" class="form-label">Khu vực</label>
            <input type="text" id="region" class="form-control" required />
          </div>
               <div class="mb-3">
            <label for="year" class="form-label">Năm</label>
            <input type="number" step="1" id="year" class="form-control" required />
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button type="button" class="btn btn-primary" onclick="submitForm()">Lưu</button>
      </div>
    </div>
  </div>
</div>

      `;
    });

    document.getElementById("population-container").innerHTML = htmlContent;
    updatePagination();
  }

  function updatePagination() {
    let select = document.getElementById("pageSelect");
    select.innerHTML = "";

    for (let i = 1; i <= totalPages; i++) {
      let option = document.createElement("option");
      option.value = i;
      option.text = `Trang ${i}`;
      if (i === currentPage) {
        option.selected = true;
      }
      select.appendChild(option);
    }

    document.getElementById("prevBtn").disabled = currentPage === 1;
    document.getElementById("nextBtn").disabled = currentPage === totalPages;
  }

  function changePage() {
    let selectedPage = document.getElementById("pageSelect").value;
    fetchPopulation(parseInt(selectedPage), searchQuery);
  }

  function prevPage() {
    if (currentPage > 1) {
      fetchPopulation(currentPage - 1, searchQuery);
    }
  }

  function nextPage() {
    if (currentPage < totalPages) {
      fetchPopulation(currentPage + 1, searchQuery);
    }
  }

  function handleSearch() {
    searchQuery = document.getElementById("searchInput").value;
    fetchPopulation(1, searchQuery);
  }
  document
    .getElementById("searchInput")
    .addEventListener("keydown", function (event) {
      if (event.key === "Enter") {
        event.preventDefault(); // Ngăn form submit mặc định
        handleSearch();
      }
    });
  fetchPopulation();
  async function openModal(id = null) {
    if (id) {
      const response = await fetch(
        `https://api.pplt-dev.vitlab.site/api/populations/province/${id}`
      );
      const data = await response.json();

      document.getElementById("recordId").value = data._id;
      document.getElementById("province").value = data.province;
      document.getElementById("populationDensity").value =
        data.populationDensity;
      document.getElementById("averagePopulation").value =
        data.averagePopulation;
      document.getElementById("genderRatio").value = data.genderRatio;
      document.getElementById("laborForce").value = data.laborForce;
      document.getElementById("populationGrowthRate").value =
        data.populationGrowthRate;
      document.getElementById("region").value = data.region;
      document.getElementById("year").value = data.year;
    } else {
      document.getElementById("recordId").value = "";
      document.getElementById("populationForm").reset();
    }

    new bootstrap.Modal(document.getElementById("populationModal")).show();
  }

  async function submitForm() {
    const id = document.getElementById("recordId").value;
    const payload = {
      province: document.getElementById("province").value,
      populationDensity: parseFloat(
        document.getElementById("populationDensity").value
      ),
      averagePopulation: parseFloat(
        document.getElementById("averagePopulation").value
      ),
      genderRatio: parseFloat(document.getElementById("genderRatio").value),
      laborForce: parseFloat(document.getElementById("laborForce").value),
      populationGrowthRate: parseFloat(
        document.getElementById("populationGrowthRate").value
      ),
      region: document.getElementById("region").value,
      year: parseInt(document.getElementById("year").value),
    };

    let url = `https://api.pplt-dev.vitlab.site/api/populations/province`;
    let method = "POST";

    if (id) {
      url += `/${id}`;
      method = "PUT";
    }
    console.log(JSON.stringify(payload));
    const response = await fetch(url, {
      method: method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    if (response.ok) {
      document
        .getElementById("populationModal")
        .querySelector(".btn-close")
        .click();
      fetchPopulation();
    } else {
      alert("Có lỗi xảy ra khi lưu dữ liệu!");
    }
  }
  async function deletePopulation(id) {
    if (confirm("Bạn có chắc muốn xóa?")) {
      const response = await fetch(
        `https://api.pplt-dev.vitlab.site/api/populations/province/${id}`,
        { method: "DELETE" }
      );

      if (response.ok) {
        fetchPopulation();
      } else {
        alert("Không thể xóa dữ liệu!");
      }
    }
  }
</script>

{% endblock %}
